services:
  whoami-app:
    image: traefik/whoami
    container_name: whoami-app
    restart: unless-stopped
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.services.whoami-app.loadbalancer.server.port=80"

      # Router A — sous-domaines 1 niveau de demo-tibillet.ovh (OVH DNS-01)
      - "traefik.http.routers.app-ovh.rule=HostRegexp(`{sub:[^.]+}.demo-tibillet.ovh`)"
      - "traefik.http.routers.app-ovh.entrypoints=websecure"
      - "traefik.http.routers.app-ovh.tls=true"
      - "traefik.http.routers.app-ovh.tls.certresolver=le-ovh"
      - "traefik.http.routers.app-ovh.tls.domains[0].main=demo-tibillet.ovh"
      - "traefik.http.routers.app-ovh.tls.domains[0].sans=*.demo-tibillet.ovh"
      - "traefik.http.routers.app-ovh.priority=100"
      # Router A2 — apex demo-tibillet.ovh (séparé)
      - "traefik.http.routers.app-ovh-apex.rule=Host(`demo-tibillet.ovh`)"
      - "traefik.http.routers.app-ovh-apex.entrypoints=websecure"
      - "traefik.http.routers.app-ovh-apex.tls=true"
      - "traefik.http.routers.app-ovh-apex.tls.certresolver=le-ovh"
      - "traefik.http.routers.app-ovh-apex.priority=110"
#      - "traefik.http.routers.app-ovh.middlewares=crowdsec@file"

      # Router B — tous les sous-domaines 1 niveau de codecommun.coop (Gandi DNS-01)
#      - "traefik.http.routers.app-gandi.rule=HostRegexp(`{sub:[^.]+}.codecommun.coop`)"
#      - "traefik.http.routers.app-gandi.entrypoints=websecure"
#      - "traefik.http.routers.app-gandi.tls=true"
#      - "traefik.http.routers.app-gandi.tls.certresolver=le-gandi"
#      - "traefik.http.routers.app-gandi.tls.domains[0].main=codecommun.coop"
#      - "traefik.http.routers.app-gandi.tls.domains[0].sans=*.codecommun.coop"
#      - "traefik.http.routers.app-gandi.middlewares=crowdsec@file"

      # Router C — host exact agenda.nasjo.fr (TLS-ALPN)
      - "traefik.http.routers.app-agenda.rule=Host(`agenda.nasjo.fr`)"
      - "traefik.http.routers.app-agenda.entrypoints=websecure"
      - "traefik.http.routers.app-agenda.tls=true"
      - "traefik.http.routers.app-agenda.tls.certresolver=le-alpn"
#      - "traefik.http.routers.app-agenda.middlewares=crowdsec@file"

networks:
  frontend:
    external: true
